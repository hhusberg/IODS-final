---
title: "Final Assignment"
author: "Henrik Husberg"
date: "23.02 2017"
output: html_document
---
henrik.husberg@gmail.com
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Open Data Science - Final Assignment

## _Abstract_

_In the first part of this two-part study we attempt to identify the links between television viewing time, internet time, digital gaming time and ADHD-related behavior as well as school achievement in Finnish grade-school children (grades 1-9), controlling for gender, age and socioeconomic status. In the second part we investigate the relationships between electronic media usage in younger children (grades 1-3), ADHD-related behavior and cognitive performance. Results indicate small negative, mostly non-significant effects of television time on ADHD-related behavior and school achievement while a small positive relationship between internet and game time and visuospatial working memory. Previous research on the links between electronic media usage, attention and school achievement has been inconclusive. For example, some negative links have been shown between total hours viewing TV and school achievement and ADHD-related behaviors, while some positive links have been found between digital gaming and visual spatial skills. The current study sheds some light on these relationships._

## Research Questions and Hypotheses

The current research will attempt to address some of the above mentioned issues in two studies: in study 1 we investigate the relationship between television time, internet use and videogame playing and ADHD-related behavior and school achievement in grades 1-9. In Study 2 we investigate the relationship between the three measures of media use, ADHD-related behavior, school achievement and cognitive abilities in grades 1 and 3. In both studies, we control for age, gender and SES. Based on previous research we will test the following hypotheses: 

**H1:** Media time has a small negative effect on ADHD-related behavior and school achievement.

**H2:** Media time has a negative effect on reading habits, which in turn have a positive effect on attention and achievement at school.

**H3:** An effect of media time on school achievement is partially mediated by increased ADHD-related behavior.
<!--
**H4:** An effect of media time on ADHD-related behavior and school achievement is partially mediated by visuospatial ability.
-->
## Data Wrangling

_**Attention:** This is not a complete dataset and it may not be used outside this course. There are both variables and observations missing. Any inferences to real life are completely fictional and are only used for the purpose of this course. The dataset in its entirety belongs to the Niilo MÃ¤ki Institute and results based on the complete dataset will be presented at the JURE2017 conference for those interested._

Read the data from SPSS-generated csv-file. I've wrangled the data quite a bit (actually even a lot more than shows in the script file). The script can be found [here](https://github.com/hhusberg/IODS-final/blob/master/data/create_final.R).


## Data Description

The data I have is take from an ongoing study into Swedish speaking childrens' attention and executive skills at school. After wrangling around I've got this datafile to work with. I've decided to go all continuous with this dataset. Most variables are measured on a Likert-type scale with ranges varying from 3 to 7.

```{r}
setwd("C:/Users/hehusb/Documents/GitHub/IODS-final")
#setwd("C:/Users/hhusberg/Documents/GitHub/IODS-final")
kesky <- read.csv2(file = "./data/final_cont.csv")
dim(kesky)
#str(kesky)
#str(hur_garna_lasbarn1)
```


### Attention & executive function: measured by a 55-item questionnaire (variables 2-56)

```{r}
which(names(kesky)%in%c("dist_01", "efutv_55"))
#summary(kesky[, 2:56])
```

### School achievement: mesured by 2 questions (math/Swedish grade) (variables 57-58)

```{r}
which(names(kesky)%in%c("vitsord_ma", "vitsord_mo"))
#summary(kesky[, 57:58])
```

### Media time: Measured by 3-item questionnaire where q1 = TV time, q2 = Internet time and q3 = Video game time (variables 61-63)

```{r}
which(names(kesky)%in%c("medievanor1", "medievanor3"))
#summary(kesky[, 61:63])
```

### Reading preferences: Measured by 7 questions (variables 74-80) and Reading habits: Measured by 7 questions (variables 81-87)

```{r}
which(names(kesky)%in%c("hur_garna_lasbarn7", "hur_ofta_lasbarn1"))
#summary(kesky[, 64:77])
```


### Control variables: SES, here measured by parents' highest educational level (variables 65-66) and gender, (variable 2)

```{r}
which(names(kesky)%in%c("utb_pabygg_mamma", "utb_pabygg_pappa"))
#summary(kesky[, 59:60])

which(names(kesky)%in%c("elev_kon"))
#summary(kesky[, 1])
```


## Method




## Results

First of all I want to reduce the amount of variables measuring attention. This data with 55 variables is very unyieldy. I'll start by  exploring the patterns of this data. 

```{r}
#First I'll make a dataframe with only the ATTEX variables:
kesky_only <- kesky[, 2:56]
#summary(kesky_only)
dim(kesky_only)
#str(kesky_only)
pca_kesky <- prcomp(kesky_only)
s <- summary(pca_kesky)
# s

# rounded percetanges of variance captured by each PC
pca_pr <- round(100*s$importance[2, ], digits = 1)

# print out the percentages of variance
pca_pr

# create object pc_lab to be used as axis labels
pc_lab <- paste0(names(pca_pr), " (", pca_pr, "%)")
pc_lab[1:10]

# draw a biplot
biplot(pca_kesky, cex = c(0.8, 1), col = c("grey40", "deeppink2"), xlab = pc_lab[1], ylab = pc_lab[2])
```

Unfortunaltely there's no really visible pattern here. Possibly it could be discerned that motor restlessness and some of the executive components load a bit more on PC2 (negative motor restlessness, positiv executive function) and most of the others load more on PC1. This does however not help us in reducing the dimension without losing most of the theoretical sense of the questionnaire. One of the problems with this data is that the questionnaires scale is 0-2 and the data is heavily zero-inflated- In order to increase variance and scale, I've formed sum variables across the ten theoretical subscales in the questionnaire, described below:

* Distractibility - 4 questions
* Impulsivity - 9 questions
* Motor restlessness - 7 questions
* Attentional direction - 5 questions
* ATtentional maintainance - 6 questions
* Attentional shifting - 4 questions
* Executive Functions, getting started - 5 questions
* Executive Functions, planning - 4 questions
* Executive Functions, executing - 8 questions
* Exectuive Functions, evaluating - 3 questions

I've prepared a dataset with sum scores of the items grouped under separate constructs in the questionnaire. Lets look at that:

```{r}
setwd("C:/Users/hehusb/Documents/GitHub/IODS-final")
#setwd("C:/Users/hhusberg/Documents/GitHub/IODS-final")

kesky_sums <- read.csv2(file = "./data/final_sums_2.csv")
kesky_sums <- as.data.frame(kesky_sums)
#kesky_sums[23:32]
dim(kesky_sums)
head(kesky_sums)
names(kesky_sums)

sums_pca <- prcomp(kesky_sums[7:16])
s2 <- summary(sums_pca)
pca2_pr <- round(100*s2$importance[2, ], digits = 1)
pca2_pr

pc_lab <- paste0(names(pca2_pr), " (", pca2_pr, "%)")
pc_lab[1:10]
biplot(sums_pca, cex = c(0.3, 0.8), col = c("grey40", "deeppink2"), xlab = pc_lab[1], ylab = pc_lab[2])
```

This looks much the same as the previous biplot but it's a lot easier to read. The components seem to be mirrored along the X-axis but are clustered quite similarly. Two components would explain almost 85% of the variance. However, all variables seem to be quite closely related since all arrows point somewhat in the same direction. As in the PCA with all the variables above, one could separate one component having more to do with restlessness and impulsiveness (_moto_ and _imp_ in the biplot) and one component having more to do with maintaining and directing attention as well as executive funtions (_uppr_, _rikt_, _efig_ and _efutf_). These components also seem to make theoretical sense, as motor restlessness and impulsiveness are the clearest signs of ADHD/hyperactive.

Now as stated before, I'm interested in seeing how media usage is connected with attention at school and school achievement. I'll start off by eyeballing my data and then doing a corrplot of the variables that interest me. 

```{r}


library(GGally)
library(ggplot2)

library(corrplot)
library(dplyr)
names(kesky_sums)

p <- ggpairs(kesky_sums, mapping = aes(col = elev_kon, alpha = 0.3), lower = list(combo = wrap("facethist", bins = 20)))
p

# Need to change the gender variable to numeric to use it in the corrplot:

#kesky_one$elev_kon
#levels(kesky_one$elev_kon) <-c(1,2)
#levels(kesky_one$elev_kon)
#as.numeric(levels(kesky_one$elev_kon))
#kesky_one$elev_kon <- as.numeric(kesky_one$elev_kon)
#kesky_one$elev_kon



# Correlations:
#cor_matrix <- cor(kesky_one) %>% round(digits = 2)
#cor_matrix
#corrplot(cor_matrix, method="ellipse", type="upper", cl.pos="b", tl.pos="d", tl.cex=0.6)
```

In order to be able to use this in my analyses, I'll try to form latent variables using the sum scores. One strength of latent variables is that they can be used to reduce the dimensions of the data while factoring out the error variance. A latent variable represents some underlying factor that explains the covariance matrix shaped by the measured (or manifest) variables. A latent variable when used in confirmatory analyses should be based on theory. In this case, as stated above, it makes theoretical sense that the questionnaire could be represented by a two-factor model, where one factor explains the most visible signs of ADHD/hyperactive and the other factor explains executive difficulties such as planning and evaluating.

I've already lost a bit of information while forming the sum scores, but because there is not enough variance in the original variables that's a tradeoff I'm forced to make. Next I'll use the [lavaan package](http://lavaan.ugent.be/) in order to conduct Confirmatory Factor Analysis and Structural Equation Modeling (CFA/SEM).
```{r}
library(lavaan)
library(semPlot)
#CFA two factor model of sum variables here
names(kesky_sums)
kesky.model.two.sums <- ' hy =~ moto + imp 
ef =~ dist + rikt + uppr + skif + efig + efpl + efutf + efutv '

fit.two.sums <- cfa(kesky.model.two.sums, data = kesky_sums)
cfa.two.sums <- summary(fit.two.sums, fit.measures = TRUE, standardized =TRUE, modindices=TRUE)
coef(fit.two.sums)
```

Lookin at the fit of the model, it does seem to work quite well. I'll repeat the central measurements of model fit below for clarity and the do a semPlot to visualize the model:
```{r}
fitMeasures(fit.two.sums, "cfi")
fitMeasures(fit.two.sums, "rmsea")
```

The two factors conform with the theory of ADHD as divided into a) predominantly hyperactive and b) predominantly inattentive. However, the RMSEA goodness of fit index does not indicate an acceptable model fit (should be below 0.6) and the CFI goodness if fit indes is a bit borderline (over .95 preferred).
```{r}
```



In the subsequent analyses we will use these latent variables to see how they are related to media consumption, reading and school achievement.
```{r}
semPaths(fit.two.sums, what="std", label.cex=1.5, edge.label.cex=1.3)

```





Based on this correlation plot, it does not seem like children's media time has any strong effects on either their attention at shool, their school achievement or their reading habits.

Next I'll conduct hierarchical linear regression analyses using first attention then school achievement as target variables. Gender and SES will be included in all models as control variables:

```{r}
#kesky_lm <- lm(attention ~ medievanor1 + medievanor2 + medievanor3 + read_habs + read_pref + elev_kon + ses, data = kesky_one)
#summary(kesky_lm)

#kesky_lm2 <- lm(vitsord_ma ~ attention + medievanor1 + medievanor2 + medievanor3 + read_habs + read_pref + elev_kon + ses, data = kesky_one)
#summary(kesky_lm2)

#kesky_lm3 <- lm(vitsord_mo ~ attention + medievanor1 + medievanor2 + medievanor3 + read_habs + read_pref + elev_kon + ses, data = kesky_one)
#summary(kesky_lm3)


```
```{r}
#kesky_lm4 <- lm(read_pref ~ medievanor1 + medievanor2 + medievanor3, data = kesky_one)
#summary(kesky_lm4)

#kesky_lm5 <- lm(read_habs ~ medievanor1 + medievanor2 + medievanor3, data = kesky_one)
#summary(kesky_lm5)
```

So based on the above regressions, it seems that in accordance with our hypotheses: 

* Media time has a small negative effect on attention and achievement at school (H1)

* The effect of media time on school achievement could be mediated by the effect on attention (H3)

However, we did not find an effect of media time on either of the reading measures (habits or preferences, H2).

Because this data does not lend itself to a latent variable approach, I'll conduct patha analyses using manifest sum variables.

```{r}

#pa.model <- ' 
#ach =~ vitsord_ma + vitsord_mo

#ach ~ attention + read_pref + read_habs
#attention ~ medievanor1 + medievanor2 + medievanor3
#read_habs ~ medievanor1 + medievanor2 + medievanor3
#read_pref ~ medievanor1 + medievanor2 + medievanor3
#' 
#fit.pa <- sem(pa.model, data=kesky_one) 
#summary(fit.pa, fit.measures=TRUE, standardized=TRUE)

```

## Discussion