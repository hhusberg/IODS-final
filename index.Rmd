---
title: "Final Assignment"
author: "Henrik Husberg"
date: "23.02 2017"
output: html_document
---
henrik.husberg@gmail.com
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Open Data Science - Final Assignment

## _Abstract_

_In the first part of this two-part study we attempt to identify the links between television viewing time, internet time, digital gaming time and ADHD-related behavior as well as school achievement in Finnish grade-school children (grades 1-9), controlling for gender, age and socioeconomic status. In the second part we investigate the relationships between electronic media usage in younger children (grades 1-3), ADHD-related behavior and cognitive performance. Results indicate small negative, mostly non-significant effects of television time on ADHD-related behavior and school achievement while a small positive relationship between internet and game time and visuospatial working memory. Previous research on the links between electronic media usage, attention and school achievement has been inconclusive. For example, some negative links have been shown between total hours viewing TV and school achievement and ADHD-related behaviors, while some positive links have been found between digital gaming and visual spatial skills. The current study sheds some light on these relationships._

## Research Questions and Hypotheses

The current research will attempt to address some of the above mentioned issues in two studies: in study 1 we investigate the relationship between television time, internet use and videogame playing and ADHD-related behavior and school achievement in grades 1-9. In Study 2 we investigate the relationship between the three measures of media use, ADHD-related behavior, school achievement and cognitive abilities in grades 1 and 3. In both studies, we control for age, gender and SES. Based on previous research we will test the following hypotheses: 

**H1:** Media time has a small negative effect on ADHD-related behavior and school achievement.

**H2:** Media time has a negative effect on reading habits, which in turn have a positive effect on attention and achievement at school.

**H3:** An effect of media time on school achievement is partially mediated by increased ADHD-related behavior.
<!--
**H4:** An effect of media time on ADHD-related behavior and school achievement is partially mediated by visuospatial ability.
-->
## Data Wrangling

_**Attention:** This is not a complete dataset and it may not be used outside this course. There are both variables and observations missing. Any inferences to real life are completely fictional and are only used for the purpose of this course. The dataset in its entirety belongs to the Niilo MÃ¤ki Institute and results based on the complete dataset will be presented at the JURE2017 conference for those interested._

Read the data from SPSS-generated csv-file. I've wrangled the data quite a bit (actually even a lot more than shows in the script file). The script can be found [here](https://github.com/hhusberg/IODS-final/blob/master/data/create_final.R).


## Data Description

The data I have is take from an ongoing study into Swedish speaking childrens' attention and executive skills at school. After wrangling around I've got this datafile to work with. I've decided to go all continuous with this dataset. Most variables are measured on a Likert-type scale with ranges varying from 3 to 7.

```{r}
setwd("C:/Users/hehusb/Documents/GitHub/IODS-final")
#setwd("C:/Users/hhusberg/Documents/GitHub/IODS-final")
kesky <- read.csv2(file = "./data/final_cont.csv")
dim(kesky)
#str(kesky)
#str(hur_garna_lasbarn1)
```


### Attention & executive function: measured by a 55-item questionnaire (variables 2-56)

```{r}
which(names(kesky)%in%c("dist_01", "efutv_55"))
#summary(kesky[, 2:56])
```

### School achievement: mesured by 2 questions (math/Swedish grade) (variables 57-58)

```{r}
which(names(kesky)%in%c("vitsord_ma", "vitsord_mo"))
#summary(kesky[, 57:58])
```

### Media time: Measured by 3-item questionnaire (variables 61-63)

```{r}
which(names(kesky)%in%c("medievanor1", "medievanor3"))
#summary(kesky[, 61:63])
```

### Reading preferences: Measured by 7 questions (variables 74-80) and Reading habits: Measured by 7 questions (variables 81-87)

```{r}
which(names(kesky)%in%c("hur_garna_lasbarn7", "hur_ofta_lasbarn1"))
#summary(kesky[, 64:77])
```


### Control variables: SES, here measured by parents' highest educational level (variables 65-66) and gender, (variable 2)

```{r}
which(names(kesky)%in%c("utb_pabygg_mamma", "utb_pabygg_pappa"))
#summary(kesky[, 59:60])

which(names(kesky)%in%c("elev_kon"))
#summary(kesky[, 1])
```


## Method




## Results

First of all I want to reduce the amount of variables measuring attention. This data with 55 variables is very unyieldy. I'll start by  exploring the patterns of this data. 

```{r}
#First I'll make a dataframe with only the ATTEX variables:
kesky_only <- kesky[, 2:56]
#summary(kesky_only)
dim(kesky_only)
#str(kesky_only)
pca_kesky <- prcomp(kesky_only)
s <- summary(pca_kesky)
# s

# rounded percetanges of variance captured by each PC
pca_pr <- round(100*s$importance[2, ], digits = 1)

# print out the percentages of variance
pca_pr

# create object pc_lab to be used as axis labels
pc_lab <- paste0(names(pca_pr), " (", pca_pr, "%)")
pc_lab[1:10]

# draw a biplot
biplot(pca_kesky, cex = c(0.8, 1), col = c("grey40", "deeppink2"), xlab = pc_lab[1], ylab = pc_lab[2])
```

Unfortunaltely there's no really visible pattern here. Possibly it could be discerned that motor restlessness and some of the executive components load a bit more on PC2 (negative motor restlessness, positiv executive function) and most of the others load more on PC1. This does however not help us in reducing the dimension without losing most of the theoretical sense of the questionnaire.

Luckily, I've also prepared a dataset with sum scores of the items grouped under separate constructs in the questionnaire. Lets look at that:

```{r}
setwd("C:/Users/hehusb/Documents/GitHub/IODS-final")
#setwd("C:/Users/hhusberg/Documents/GitHub/IODS-final")

kesky_sums <- read.csv2(file = "./data/final_sums.csv")
kesky_sums <- as.data.frame(kesky_sums)
#kesky_sums[23:32]
dim(kesky_sums)
head(kesky_sums)

sums_pca <- prcomp(kesky_sums[23:32])
s2 <- summary(sums_pca)
pca2_pr <- round(100*s2$importance[2, ], digits = 1)
pca2_pr

pc_lab <- paste0(names(pca2_pr), " (", pca2_pr, "%)")
pc_lab[1:10]
biplot(sums_pca, cex = c(0.3, 0.8), col = c("grey40", "deeppink2"), xlab = pc_lab[1], ylab = pc_lab[2])
```

Naturally this looks much the same as the previous biplot but it's alot easier to read. Two components would explain almost 85% of the variance. However, all variables seem to be quite closely related since all arrows point somewhat in the same direction. Potentially one could separate one component having more to do with restlessness and impulsiveness (_moto_ and _imp_ in the biplot) and one component having more to do with maintaining and directing attention as well as executive funtions (_uppr_, _rikt_, _efig_ and _efutf_).

It looks like I might be just as well of using a single summed up variable for the attention questionnaire. Luckily I anticipated this and have already created that sum variable in my dataframe. I'll go ahead and make a newdataframe without the lower level summed variables. At the same time I'll take the means of the reading variables:

```{r}
library(dplyr)
summary(kesky_sums$attention)

remove <- names(kesky_sums[23:32])
kesky_one <- dplyr::select(kesky_sums, -one_of(remove))
#summary(kesky_one)

names(kesky_one)
read_habs_columns <- kesky_one[9:15]
head(read_habs_columns)
kesky_one$read_habs <- rowSums(read_habs_columns) 
summary(kesky_one$read_habs)
#summary(kesky_one)

read_pref_columns <- kesky_one[16:22]
head(read_pref_columns)
kesky_one$read_pref <- rowSums(read_pref_columns) 
summary(kesky_one$read_pref)
#summary(kesky_one)

names(kesky_one)
remove2 <- names(kesky_one[9:22])
remove2
kesky_one <- dplyr::select(kesky_one, -one_of(remove2))
#summary(kesky_one)

```


Now as stated before, I'm interested in seeing how media usage is connected with attention at school and school achievement. I'll start off by eyeballing my data and then doing a corrplot of the variables that interest me: 

```{r}
library(GGally)
library(ggplot2)
p <- ggpairs(kesky_one, mapping = aes(col = elev_kon, alpha = 0.3), lower = list(combo = wrap("facethist", bins = 20)))
p

library(corrplot)
str(kesky_one)

# Oh, need to change the gender variable to numeric to use it in the corrplot:

#kesky_one$elev_kon
levels(kesky_one$elev_kon) <-c(1,2)
#levels(kesky_one$elev_kon)
#as.numeric(levels(kesky_one$elev_kon))
kesky_one$elev_kon <- as.numeric(kesky_one$elev_kon)
kesky_one$elev_kon



# Correlations:
cor_matrix <- cor(kesky_one) %>% round(digits = 2)
cor_matrix
corrplot(cor_matrix, method="ellipse", type="upper", cl.pos="b", tl.pos="d", tl.cex=0.6)
```

Based on this correlation plot, it does not seem like children's media time has any significant effect on either their attention at shool, their school achievement or their reading habits.

Next I'll conduct regression analyses using first attention then school achievement as target variables:

```{r}
kesky_lm <- lm(attention ~ medievanor1 + medievanor2 + medievanor3 + read_habs + read_pref, data = kesky_one)
summary(kesky_lm)

kesky_lm2 <- lm(vitsord_ma ~ attention + medievanor1 + medievanor2 + medievanor3 + read_habs + read_pref, data = kesky_one)
summary(kesky_lm2)

kesky_lm3 <- lm(vitsord_mo ~ attention + medievanor1 + medievanor2 + medievanor3 + read_habs + read_pref, data = kesky_one)
summary(kesky_lm3)

kesky_lm4 <- lm(read_pref ~ medievanor1 + medievanor2 + medievanor3, data = kesky_one)
summary(kesky_lm4)

kesky_lm5 <- lm(read_habs ~ medievanor1 + medievanor2 + medievanor3, data = kesky_one)
summary(kesky_lm5)

```

So based on the above regressions, it seems that in accordance with our hypotheses: 

* Media time has a small negative effect on attention and achievement at school (H1)

* The effect of media time on school achievement could be mediated by the effect on attention (H3)

However, we did not find an effect of media time on either of the reading measures (habits or preferences, H2).

Because I'm afraid there's quite a bit of error in my measurements I will also look at these relationships using confirmatory factor analysis and structural equation modeling. This has the advantages of reducing the amount of error by constructing latent variables using several items that supposedly measure the same underlying construct. In order to do this, I'll use the _lavaan_ package.

```{r}
library(lavaan)

#For this, I'll go back to the kesky dataframe
dim(kesky)
#And construct the following latent variables
kesky.model <- ' dist_l =~ dist_01 + dist_02 + dist_03 + dist_04 
imp_l =~ imp_05 + imp_06 + imp_07 + imp_08 + imp_09 + imp_10 + imp_11 + imp_12 + imp_13 
uppr_l =~ moto_14 + moto_15 + moto_16 + moto_17 + moto_18 + moto_19 + moto_20
rikt_l =~ rikt_21 + rikt_22 + rikt_23 + rikt_24 + rikt_25
uppr_l =~ uppr_26 + uppr_27 + uppr_28 + uppr_29 + uppr_30 + uppr_31
skif_l =~ skif_32 + skif_33 + skif_34 + skif_35
efig_l =~ efig_36 + efig_37 + efig_38 + efig_39 + efig_40
efpl_l =~ efpl_41 + efpl_42 + efpl_43 + efpl_44
efutf_l =~ efutf_45 + efutf_46 + efutf_47 + efutf_48 + efutf_49 + efutf_50 + efutf_51 + efutf_52
efutv_l =~ efutv_53 + efutv_54 + efutv_55 '

fit <- cfa(kesky.model, data = kesky)
cfaten <- summary(fit, fit.measures = TRUE, standardized = TRUE)
cfaten
```
So a ten factor model does not work very well, the fit indexes are close to abysmal. We'll have a look at a one-factor model next:

```{r}
kesky.model2 <- ' attention =~ dist_01 + dist_02 + dist_03 + dist_04 + imp_05 + imp_06 + imp_07 + imp_08 + imp_09 + imp_10 + imp_11 + imp_12 + imp_13 + moto_14 + moto_15 + moto_16 + moto_17 + moto_18 + moto_19 + moto_20 + rikt_21 + rikt_22 + rikt_23 + rikt_24 + rikt_25 + uppr_26 + uppr_27 + uppr_28 + uppr_29 + uppr_30 + uppr_31 + skif_32 + skif_33 + skif_34 + skif_35 + efig_36 + efig_37 + efig_38 + efig_39 + efig_40 + efpl_41 + efpl_42 + efpl_43 + efpl_44 + efutf_45 + efutf_46 + efutf_47 + efutf_48 + efutf_49 + efutf_50 + efutf_51 + efutf_52 + efutv_53 + efutv_54 + efutv_55 '

fit2 <- cfa(kesky.model2, data = kesky)
cfaone <- summary(fit2, fit.measures = TRUE, standardized = TRUE)
```
Even worse. 

Based on the PCA above it seemed that motor restlesness and impulsivity could form a factor of their own, so next I'll try a three factor solution:

```{r}
kesky.model3 <- ' motoimp =~ imp_05 + imp_06 + imp_07 + imp_08 + imp_09 + imp_10 + imp_11 + imp_12 + imp_13 + moto_14 + moto_15 + moto_16 + moto_17 + moto_18 + moto_19 + moto_20 
uppmef =~ rikt_21 + rikt_22 + rikt_23 + rikt_24 + rikt_25 + uppr_26 + uppr_27 + uppr_28 + uppr_29 + uppr_30 + uppr_31 + efig_36 + efig_37 + efig_38 + efig_39 + efutf_45 + efutf_46 + efutf_47 + efutf_48 + efutf_49 + efutf_50 + efutf_51 + efutf_52
therest =~ skif_32 + skif_33 + skif_34 + skif_35 + dist_01 + dist_02 + dist_03 + dist_04 + efig_40 + efpl_41 + efpl_42 + efpl_43 + efpl_44  + efutv_53 + efutv_54 + efutv_55 '

fit3 <- cfa(kesky.model3, data=kesky)
cfathree <- summary(fit3, fit.measures=TRUE, standardized=TRUE)
```


Now I'll create latent variables for the reading habits and reading preferences:

```{r}
names(kesky)
#summary(kesky)
reading.model <- ' readhabs =~ hur_ofta_lasbarn1 + hur_ofta_lasbarn2 + hur_ofta_lasbarn3 + hur_ofta_lasbarn4 + hur_ofta_lasbarn5 + hur_ofta_lasbarn6 + hur_ofta_lasbarn7
readpref =~ hur_garna_lasbarn1 + hur_garna_lasbarn2 + hur_garna_lasbarn3 + hur_garna_lasbarn4 + hur_garna_lasbarn5 + hur_garna_lasbarn6 + hur_garna_lasbarn7 '

fit4 <- cfa(reading.model, data = kesky)
cfaread <- summary(fit4, fit.measures = TRUE, standardized = TRUE)

#Plot it:
library(semPlot)
semPaths(fit4, what="std", label.cex=1.5, edge.label.cex=1.3)
text(0.9,0.9,labels="CFA for reading habits and preferences")
```

This model did not work out at all. However, when we look at the questions more closely we see that reading questions 1 and 2 are related to homework (Swedish/other homework), while questions 3 and 5 are related to literature (books/comics). A theoretically more sound model would be one that assumes that habits and preferences for these two categories of reading (homework/leisure) are separate. Therefore we'll look at a four factor model next:
```{r}

reading.model2 <- ' rdhabhw =~ hur_ofta_lasbarn1 + hur_ofta_lasbarn2 
rdhablit =~ hur_ofta_lasbarn3 + hur_ofta_lasbarn5
rdprhw =~ hur_garna_lasbarn1 + hur_garna_lasbarn2 
rdprlit =~ hur_garna_lasbarn3 + hur_garna_lasbarn5 '

fit5 <- cfa(reading.model2, data = kesky)
cfaread2 <- summary(fit5, fit.measures = TRUE, standardized = TRUE)

#Plot it:
library(semPlot)
semPaths(fit5, what="std", label.cex=1.5, edge.label.cex=1.3)
text(0.9,0.9,labels="CFA for reading habits and preferences")
```



Because this data does not lend itself to a latent variable approach, I'll conduct patha analyses using manitfest sum variables.

```{r}

pa.model <- ' 
ach =~ vitsord_ma + vitsord_mo

ach ~ attention + read_pref + read_habs
attention ~ medievanor1 + medievanor2 + medievanor3
read_habs ~ medievanor1 + medievanor2 + medievanor3
read_pref ~ medievanor1 + medievanor2 + medievanor3
' 
fit.pa <- sem(pa.model, data=kesky_one) 
summary(fit.pa, fit.measures=TRUE, standardized=TRUE)

```

## Discussion